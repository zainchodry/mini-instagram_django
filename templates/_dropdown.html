{% load static %}
<div id="notif-dropdown" class="dropdown me-3">
  <a class="btn btn-light position-relative" href="#" id="notifToggle" data-bs-toggle="dropdown" aria-expanded="false">
    Notifications
    <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
  </a>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notifToggle" style="min-width: 300px;">
    <li class="px-3 py-2"><strong>Notifications</strong></li>
    <li><hr class="dropdown-divider"></li>
    <div id="notif-items" style="max-height: 300px; overflow:auto;">
      <li class="dropdown-item text-muted">Loading...</li>
    </div>
    <li><hr class="dropdown-divider"></li>
    <li class="px-3 py-2 text-end"><a href="{% url 'notifications:list' %}">View all</a></li>
  </ul>
</div>

<!-- âœ… JavaScript for dynamic notifications -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const notifBadge = document.getElementById('notif-badge');
    const notifItems = document.getElementById('notif-items');

    async function fetchNotifications() {
        try {
            const response = await fetch("{% url 'notifications:api_list' %}");
            if (!response.ok) throw new Error('Network error');

            const data = await response.json();
            notifItems.innerHTML = '';

            if (data.notifications.length === 0) {
                notifItems.innerHTML = '<li class="dropdown-item text-muted">No notifications</li>';
                notifBadge.style.display = 'none';
                return;
            }

            // Update badge count
            const unreadCount = data.notifications.filter(n => !n.is_read).length;
            if (unreadCount > 0) {
                notifBadge.textContent = unreadCount;
                notifBadge.style.display = 'inline-block';
            } else {
                notifBadge.style.display = 'none';
            }

            // Populate notifications
            data.notifications.forEach(n => {
                const item = document.createElement('li');
                item.classList.add('dropdown-item');
                if (!n.is_read) item.classList.add('fw-bold');

                let message = '';
                if (n.verb === 'like') {
                    message = `${n.actor} liked your post.`;
                } else if (n.verb === 'comment') {
                    message = `${n.actor} commented on your post.`;
                } else if (n.verb === 'follow') {
                    message = `${n.actor} started following you.`;
                }

                item.innerHTML = `
                    <div>${message}</div>
                    <small class="text-muted">${n.timestamp}</small>
                `;

                notifItems.appendChild(item);
            });

        } catch (error) {
            console.error('Error fetching notifications:', error);
            notifItems.innerHTML = '<li class="dropdown-item text-danger">Error loading notifications</li>';
        }
    }

    // Initial load
    fetchNotifications();

    // Auto refresh every 15 seconds
    setInterval(fetchNotifications, 15000);
});
</script>
